---
# yaml-language-server: $schema=schemas/talconfig.json

# renovate: datasource=docker depname=ghcr.io/siderolabs/installer
talosversion: v1.12.4
# renovate: datasource=docker depname=ghcr.io/siderolabs/kubelet
kubernetesversion: v1.35.0

clustername: &clustername milberry

endpoint: https://172.16.4.10:6443
clusterpodnets: ["10.244.0.0/16"]
clustersvcnets: ["10.86.0.0/16"]

additionalapiservercertsans: &sans
  - &kubeapiip "172.16.4.10"
  - 127.0.0.1 # kubeprism
additionalmachinecertsans: *sans

nodes:
  - hostname: n1
    controlplane: true
    ipaddress: 172.16.4.11
    installdiskselector: &bootdisk
      size: < 200gb
    networkinterfaces:
      - interface: eth0
        dhcp: true
        vip:
          ip: *kubeapiip
      - interface: eth1
        addresses:
          - 10.10.10.11/24
    # https://factory.talos.dev/?arch=amd64&board=undefined&bootloader=sd-boot&cmdline=-console+console%3dtty0&cmdline-set=true&extensions=-&extensions=siderolabs%2fqemu-guest-agent&extensions=siderolabs%2fthunderbolt&platform=nocloud&secureboot=true&target=cloud&version=1.12.4
    talosimageurl: &talosminimalimage factory.talos.dev/nocloud-installer-secureboot/650b29344f1a1cb82b40720354a44a0b6ce2037dcae47472ddacad7dd891a1eb
    schematic: &schematicminimal
      customization:
        extrakernelargs:
          - -console
          - console=tty0
        systemextensions:
          officialextensions:
            - siderolabs/qemu-guest-agent
            - siderolabs/thunderbolt
    patches: &zfspatches
      - |
        machine:
          kubelet:
            extramounts:
              - destination: /var/mnt/local-pool
                type: bind
                source: /var/mnt/local-pool
                options:
                  - bind
                  - rshared
                  - rw
          disks:
            - device: /dev/sdb
              partitions:
                - mountpoint: /var/mnt/local-pool
    nodelabels: &ms01cluster
      hardware/manufacturer: "minisforum"
      hardware/model: "ms-01"
      node-role.kubernetes.io/control-plane: "control-plane"
      topology.kubernetes.io/region: &region "us-central"
      topology.kubernetes.io/zone: *clustername
  - hostname: n2
    controlplane: true
    ipaddress: 172.16.4.12
    installdiskselector: *bootdisk
    networkinterfaces:
      - interface: eth0
        dhcp: true
        vip:
          ip: *kubeapiip
      - interface: eth1
        addresses:
          - 10.10.10.12/24
    talosimageurl: *talosminimalimage
    schematic: *schematicminimal
    patches: *zfspatches
    nodelabels: *ms01cluster

patches:
  - "@./patches/global/time.yaml"
  - "@./patches/global/cluster-discovery.yaml"
  - "@./patches/global/containerd.yaml"
  - "@./patches/global/hostdns.yaml"
  - "@./patches/global/kubelet.yaml"
  - "@./patches/global/openebs.yaml"
  - "@./patches/global/sysctls.yaml"
  - "@./patches/global/luks2.yaml"

controlplane:
  patches:
    - "@./patches/control/cluster.yaml"
    - "@./patches/control/api-access.yaml"
    - "@./patches/control/disable-admission-control.yaml"
